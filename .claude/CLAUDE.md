# Internal Agent Instructions

> Implement the most concise solution that changes as little code as possible.

## STARTUP CHECKS (MANDATORY - Every Session)

**Before doing ANY work, verify:**

```bash
python scripts/architecture_drift_detector.py
```

If drift detected â†’ FIX FIRST before proceeding.

**SSOT**: `config/canonical.yaml` is the single source of truth for:
- Ports (QuestDB, Grafana, Redis)
- Versions (NT, Python, containers)
- Paths (catalog, nightly env)

**Never assume** - always verify from SSOT or installed packages.

## Agent Delegation (MANDATORY)

| Task | Agent | Why |
|------|-------|-----|
| Log analysis | backtest-analyzer | Chunked processing, avoids context bloat |
| Bug hunting | alpha-debug | Iterative rounds, finds edge cases |
| Test execution | test-runner | Full output capture, clean context |
| NT implementation | nautilus-coder | Native Rust, best practices |
| Charts/dashboards | nautilus-visualization-renderer | Canvas 2D/WebGL |
| Grafana edits | alpha-visual | Screenshot validation after EVERY edit |
| Large docs/research | Task agents | Parallel analysis, own context windows |

**Rule**: NEVER read large documents directly - delegate to agents. Main context = orchestration only.

## Trading Code Rules

**Absolute Requirements**:
- Complete strategies only (no partial/simplified)
- Test every strategy (unit + backtest, real market data, 80% coverage)
- No: code duplication | dead code | cheater tests | lookahead bias | resource leaks
- Separate: strategy logic from data management
- Follow NautilusTrader naming conventions

**Testing**: Use test-runner agent | Real market data | Verbose output | Don't proceed until green

## TDD Workflow

```
/tdd:cycle      - Full Red-Green-Refactor
/tdd:cycle-safe - With automatic rollback
/tdd:red|green|refactor - Individual phases
/tdd:spec-to-test - Spec to test cases
```

**Integration**: `/speckit:specify` -> `/tdd:spec-to-test` -> `/tdd:cycle-safe` -> `task-master complete`

## Development Flow

```
1. Spec:    /speckit.constitution -> specify -> plan -> tasks
2. Tasks:   task-master parse-prd -> next
3. Impl:    /undo:checkpoint -> /tdd:cycle-safe -> task-master complete
4. Search:  Context7 (API) | Discord (bugs/workarounds) | backtest-analyzer (logs)
```

## Changelog Files

| File | Purpose |
|------|---------|
| `docs/nautilus/nautilus-trader-changelog.json` | Machine-readable (automation) |
| `docs/nautilus/nautilus-trader-changelog.md` | Human-readable (agents) |

Generated by N8N workflow in `/media/sam/1TB/devteam1`

## Mypy Fix Rules (CRITICAL)

**After ANY type annotation changes, ALWAYS run tests:**
```bash
uv run pytest tests/ -x --tb=line  # Stop on first failure
```

**NEVER do:**
- `cast(NDArray[...], x)` at runtime - NDArray is TYPE_CHECKING only
- Import inside functions for type hints
- Change function signatures without checking callers

**PREFER:**
- `return x  # type: ignore[error-code]` over runtime casts
- Add TYPE_CHECKING imports at module level
- Verify tests pass BEFORE marking task complete

## Core Rules

- NEVER create files unless necessary | ALWAYS edit existing
- NEVER create docs unless requested | Do exactly what's asked
- Search Context7 + Discord BEFORE implementing
