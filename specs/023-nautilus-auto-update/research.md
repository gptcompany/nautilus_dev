# Research: NautilusTrader Auto-Update Pipeline

**Feature**: 023-nautilus-auto-update
**Date**: 2025-12-29
**Status**: Complete

## Resolved Clarifications

### 1. GitHub Actions vs Local Cron

**Decision**: Hybrid approach - GitHub Actions for lightweight checks, Local cron for heavy operations

**Rationale**:
- GitHub Actions: Version checks, PR creation, CI validation (infrastructure-free, audit trail)
- Local Cron: Catalog regeneration, full backtests (access to `/media/sam/` paths)
- Limitation: GH Actions can't access local catalogs; local cron can't create PRs natively

**Implementation**:
```
GitHub Actions (04:00 UTC):
  - Check PyPI for nightly version
  - Compare with current
  - Trigger Discord webhook if update available

Local Cron (05:00 UTC, after GH Actions):
  - Pull changelog.json (already generated by N8N)
  - Run impact analysis
  - Run tests
  - Create/update branch
  - Use gh CLI for PR creation
```

### 2. PR Approval Flow

**Decision**: Confidence-gated Human-in-the-Loop (HITL)

**Confidence Levels**:
| Level | Score | Approval Flow |
|-------|-------|---------------|
| Very High | ≥85 | Auto-merge with 2h safety delay |
| High | 65-84 | Auto-merge after 24h + optional review |
| Neutral | 40-64 | Manual review required, merge blocked |
| Low | <40 | Manual review + ping, email fallback |

**Scoring Factors**:
- Age (30%): Wait 24-72h after release for stability
- Breaking Changes (40%): Parse changelog for breaking_changes array
- Test Coverage (30%): pytest + backtest smoke tests pass

**Rationale**: Based on Renovate's Merge Confidence patterns. NautilusTrader nightly is volatile; require human approval for anything with breaking changes.

### 3. N8N Extension vs Separate Pipeline

**Decision**: Separate Python pipeline, consume N8N output

**Rationale**:
- N8N already generates `docs/nautilus/nautilus-trader-changelog.json` ✓
- Impact analysis requires complex Python (regex, grep, AST parsing)
- Claude Code dispatch requires subprocess control
- Python pipeline is testable, version-controlled
- N8N remains as-is for data fetching (single responsibility)

**Integration**:
```
N8N Workflow (existing, ~00:00 UTC):
  └── Fetches GitHub releases
  └── Parses changelog
  └── Writes to docs/nautilus/nautilus-trader-changelog.json

Python Pipeline (new, 05:00 UTC):
  └── Reads docs/nautilus/nautilus-trader-changelog.json
  └── Runs impact analysis
  └── Creates PRs
```

### 4. Notification Channel

**Decision**: Discord webhooks primary, email fallback for critical failures

**Rationale**:
- Discord: Real-time, team visibility, rich embeds, already in dev workflow
- Email: Only for critical failures (test suite crash, catalog corruption)
- No local desktop notifications (remote server may be unattended)

**Implementation**:
| Event | Discord | Email |
|-------|---------|-------|
| Update available (any confidence) | ✅ Rich embed | ❌ |
| Tests passed, PR created | ✅ | ❌ |
| Tests failed | ✅ w/ @ping | ✅ |
| Auto-merge completed | ✅ | ❌ |
| Critical failure (pipeline crash) | ✅ w/ @ping | ✅ |

---

## Additional Findings

### Dependabot/Renovate Patterns Applied

**Grouping**: NautilusTrader is sole dependency in update group (no bundling)

**Branch Strategy**: `update/v{version}` format (Decision 2 in plan.md confirmed)

**Auto-merge Safety**:
- 2-hour delay for very_high confidence (rollback window)
- 24-hour delay for high confidence (review opportunity)
- Never auto-merge on weekends (optional, not implemented in MVP)

### GitHub Actions Limitations

**60-day Inactivity**: Workflow auto-disables after 60 days of no commits.
- Mitigation: Repository has regular activity from development work

**UTC-only Scheduling**: All cron times are UTC.
- 04:00 UTC = 05:00 CET (winter) = 06:00 CEST (summer)
- Adjust local cron accordingly

**No Local Filesystem Access**: Can't access `/media/sam/` from GH Actions.
- Solution: Hybrid approach with local cron for heavy lifting

### Claude Code Integration

**CLI Dispatch Pattern**:
```python
subprocess.run([
    "claude",
    "--task", f"Fix NautilusTrader {version} breaking changes in this codebase. Impact report: {report_path}",
    "--yes",  # Non-interactive
], capture_output=True)
```

**Limitations**:
- No programmatic status polling (fire-and-forget)
- Agent may create multiple PRs or none
- Timeout handling required

**Mitigation**: Claude Code creates PR → pipeline monitors `gh pr list` for new PRs with `auto-update` label.

---

## Risk Analysis Update

| Risk | Likelihood | Impact | Mitigation | Residual Risk |
|------|------------|--------|------------|---------------|
| False positive breaking change | Medium | Low | Human review for <85 confidence | Low |
| GH Actions rate limits | Low | Low | Single daily run, no aggressive retries | Low |
| Claude dispatch timeout | Medium | Medium | 30-min timeout, fallback to notification | Low |
| Catalog schema mismatch | Medium | High | Never auto-merge breaking changes | Low |
| Weekend deployment issues | Low | Medium | Optional: skip weekends | Accepted |

---

## Sources

- Renovate Merge Confidence: https://docs.renovatebot.com/merge-confidence/
- Renovate Automerge: https://docs.renovatebot.com/key-concepts/automerge/
- GitHub Actions Scheduling: https://cicube.io/blog/github-actions-cron/
- Discord Webhooks API: https://discord.com/developers/docs/resources/webhook
- Human-in-the-Loop Patterns: https://zapier.com/blog/human-in-the-loop/
