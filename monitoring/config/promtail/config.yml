# ============================================================================
# Promtail Configuration
# ============================================================================
# Collects logs from Docker containers and system logs.
# Adds labels for filtering in Grafana.
# ============================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: ""
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

scrape_configs:
  # ==========================================================================
  # Docker Container Logs
  # ==========================================================================
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # Keep only running containers
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'logstream'
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: 'compose_project'
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'compose_service'
      # Add security label for filtering
      - source_labels: ['__meta_docker_container_name']
        regex: '.*(grafana|prometheus|loki|questdb|redis|n8n).*'
        target_label: 'category'
        replacement: 'infrastructure'
      - source_labels: ['__meta_docker_container_name']
        regex: '.*(nautilus|trading|strategy).*'
        target_label: 'category'
        replacement: 'trading'
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            level: level
            msg: msg
            timestamp: timestamp
            error: error
      # Extract log level
      - labels:
          level:
      # Security event detection
      - match:
          selector: '{container=~".+"}'
          stages:
            - regex:
                expression: '(?i)(login.*(fail|error|denied)|unauthorized|forbidden|invalid.*(token|credential)|brute.?force|blocked|rate.?limit)'
            - labels:
                security_event: "true"

  # ==========================================================================
  # Trading System Logs (File-based)
  # ==========================================================================
  - job_name: trading_logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: trading
          category: trading
          __path__: /var/log/nautilus/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            msg: message
            strategy: strategy_id
            symbol: symbol
            order_id: order_id
      - labels:
          level:
          strategy:
          symbol:
      # Trading alerts
      - match:
          selector: '{job="trading"}'
          stages:
            - regex:
                expression: '(?i)(order.*(reject|fail|error)|position.*(limit|exceed)|drawdown|halt|risk)'
            - labels:
                trading_alert: "true"

  # ==========================================================================
  # System Logs (Security Focus)
  # ==========================================================================
  - job_name: syslog
    static_configs:
      - targets:
          - localhost
        labels:
          job: syslog
          category: system
          __path__: /var/log/syslog
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>\S+)\s+(?P<service>\S+):\s+(?P<message>.*)$'
      - labels:
          host:
          service:
      # Security events
      - match:
          selector: '{job="syslog"}'
          stages:
            - regex:
                expression: '(?i)(sshd.*(fail|invalid|disconnect)|ufw|iptables|authentication|sudo|su\[)'
            - labels:
                security_event: "true"

  # ==========================================================================
  # Auth Logs (Critical Security)
  # ==========================================================================
  - job_name: auth
    static_configs:
      - targets:
          - localhost
        labels:
          job: auth
          category: security
          security_event: "true"
          __path__: /var/log/auth.log
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<host>\S+)\s+(?P<service>\S+):\s+(?P<message>.*)$'
      - labels:
          host:
          service:
      # Failed login detection
      - match:
          selector: '{job="auth"}'
          stages:
            - regex:
                expression: '(?i)(failed|invalid|error|denied|disconnect|refused|blocked)'
            - labels:
                auth_failure: "true"

  # ==========================================================================
  # N8N Workflow Logs
  # ==========================================================================
  - job_name: n8n
    static_configs:
      - targets:
          - localhost
        labels:
          job: n8n
          category: automation
          __path__: /var/log/n8n/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            workflow: workflowId
            execution: executionId
      - labels:
          level:
          workflow:

  # ==========================================================================
  # ML Model Logs
  # ==========================================================================
  - job_name: ml_models
    static_configs:
      - targets:
          - localhost
        labels:
          job: ml_models
          category: ml
          __path__: /media/sam/1TB/N8N_dev/logs/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            model: model_path
            action: action
      - labels:
          level:
          model:
      # ML security events
      - match:
          selector: '{job="ml_models"}'
          stages:
            - regex:
                expression: '(?i)(signature.*(invalid|fail)|integrity|tamper|load.*(error|fail))'
            - labels:
                ml_security_event: "true"
