# monitoring/docker-compose.yml
# T002: Docker Compose configuration for Grafana + QuestDB monitoring stack

services:
  questdb:
    image: questdb/questdb:9.2.3
    container_name: nautilus-questdb
    restart: unless-stopped
    ports:
      - "9000:9000"   # HTTP API + Web Console
      - "9009:9009"   # ILP (InfluxDB Line Protocol)
      - "8812:8812"   # PostgreSQL wire protocol
    volumes:
      - questdb_data:/var/lib/questdb
      - ./questdb/server.conf:/var/lib/questdb/conf/server.conf:ro
    environment:
      - QDB_CAIRO_COMMIT_MODE=nosync
      - QDB_PG_ENABLED=true
      - QDB_PG_NET_BIND_TO=0.0.0.0:8812
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/exec?query=SELECT%201"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:11.0.0
    container_name: nautilus-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Security
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      # Plugins
      - GF_INSTALL_PLUGINS=questdb-questdb-datasource
      # Alerting (unified alerting enabled)
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GF_ALERTING_ENABLED=false
      # SMTP for email alerts (optional)
      - GF_SMTP_ENABLED=${GF_SMTP_ENABLED:-false}
      - GF_SMTP_HOST=${GF_SMTP_HOST:-}
      - GF_SMTP_USER=${GF_SMTP_USER:-}
      - GF_SMTP_PASSWORD=${GF_SMTP_PASSWORD:-}
      - GF_SMTP_FROM_ADDRESS=${GF_SMTP_FROM_ADDRESS:-grafana@localhost}
      - GF_SMTP_FROM_NAME=${GF_SMTP_FROM_NAME:-Nautilus Monitoring}
      # Alerting contact point secrets
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL:-}
      - ALERT_EMAIL_ADDRESSES=${ALERT_EMAIL_ADDRESSES:-}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      questdb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - monitoring

volumes:
  questdb_data:
    driver: local
  grafana_data:
    driver: local

networks:
  monitoring:
    driver: bridge
